# Chat Demo Client

This is a Node.js CLI demo client for testing the real-time chat microservice.

## Features

- **Self-signed JWT tokens** for authentication (for demo purposes only)
- **WebSocket connections** to listen for real-time messages
- **REST API** for sending messages and fetching data
- **Interactive CLI menu** for easy testing

## Prerequisites

- Node.js 18+ installed
- Chat microservice running (via Docker Compose or locally)

## Installation

```bash
cd demo
npm install
```

## Configuration

By default, the client connects to `localhost:8080`. You can override this with environment variables:

```bash
export SERVER_HTTP=http://localhost:8080
export SERVER_WS=ws://localhost:8080
```

## Running the Demo

```bash
npm start
```

## Usage

When you start the client, you'll be prompted to:

1. **Enter your user ID**: This will be your unique identifier (e.g., `alice`)
2. **Enter your groups**: Comma-separated list of group IDs you belong to (e.g., `team-a,developers`)

The client will generate a JWT token with these credentials.

### Main Menu Options

**1. Connect to channel (WebSocket)**
- Opens a WebSocket connection to listen for messages in real-time
- You must have access to the channel (your ID or one of your groups must match the channel ID)
- Press `Ctrl+C` to disconnect

**2. Send message (REST API)**
- Sends a message to a channel via REST API
- The message sender is automatically set from your JWT token
- You must have access to the channel

**3. Get messages from channel**
- Retrieves message history from a channel
- Returns messages based on your access rights:
  - If you have full access: all channel messages
  - Otherwise: only messages where you're the sender or have access

**4. Get client counts**
- Shows how many clients are connected to specific channels
- No authentication required
- Enter comma-separated channel IDs

**5. Health check**
- Checks if the server is running
- No authentication required

**6. Exit**
- Closes the client

## Example Scenarios

### Testing Channel Access

**User 1** (alice, groups: team-a)
```
User ID: alice
Groups: team-a
```
- Can access channels: `alice`, `team-a`
- Can send/receive from these channels

**User 2** (bob, groups: team-a,developers)
```
User ID: bob
Groups: team-a,developers
```
- Can access channels: `bob`, `team-a`, `developers`

### Multi-Client Chat

1. Start the server:
   ```bash
   docker-compose up -d
   ```

2. Open terminal 1 - connect as Alice:
   ```bash
   npm start
   # User ID: alice
   # Groups: team-a
   # Select: 1 (Connect to channel)
   # Channel ID: team-a
   ```

3. Open terminal 2 - send as Bob:
   ```bash
   npm start
   # User ID: bob
   # Groups: team-a
   # Select: 2 (Send message)
   # Channel ID: team-a
   # Message: Hello team!
   ```

4. Alice will see Bob's message in real-time!

## JWT Token Structure

The demo client generates tokens with this payload:

```json
{
  "id": "alice",
  "groups": ["team-a", "developers"],
  "iat": 1234567890,
  "exp": 1234654290
}
```

**Note**: For production, tokens should be generated by a secure authentication service, not by the client!

## Troubleshooting

**Connection refused**
- Make sure the chat microservice is running
- Check SERVER_HTTP and SERVER_WS environment variables

**Forbidden error**
- Your user ID or groups don't have access to the channel
- Make sure your ID or one of your groups matches the channel ID

**WebSocket closes immediately**
- Check JWT token is valid
- Ensure you have access to the channel
